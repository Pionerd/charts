##
# This is a test that provisions a regular (non CNPG) PostgreSQL cluster and attempts to perform a pg_basebackup recovery.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: postgresql-pg-basebackup
spec:
  timeouts:
    apply: 1s
    assert: 2m
    cleanup: 1m
  steps:
    - name: Install the external PostgreSQL cluster
      try:
        - script:
            content: |
              helm upgrade \
                --install \
                --namespace $NAMESPACE \
                --values ./00-source-cluster.yaml \
                --wait \
                source ../../
        - assert:
            file: ./00-source-cluster-assert.yaml
        - apply:
            file: ./01-data_write.yaml
        - assert:
            file: ./01-data_write-assert.yaml
    - name: Install the pg_basebackup cluster
      timeouts:
        assert: 5m
      try:
        - script:
            content: |
              helm upgrade \
                --install \
                --namespace $NAMESPACE \
                --values ./01-pg_basebackup-cluster.yaml \
                --wait \
                pg-basebackup ../../
        - assert:
            file: ./01-pg_basebackup-cluster-assert.yaml
    - name: Cleanup
      try:
        - script:
            content: |
              helm uninstall --namespace $NAMESPACE pg-basebackup
